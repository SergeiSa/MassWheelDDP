close all; clc; clear;

n = 4; m = 2;
x = zeros(n, 1); u = zeros(m, 1);

Vxx  = eye(n);
Vx   = zeros(1, n);
costQ = eye(n);
costR = eye(m);


Count = 2000;
change_log = zeros(Count, 2);
K_log = zeros(m, n, Count);

for i = 1:Count
Qx = g_Qx(Vxx, Vx, costQ, costR, x, u);
Qu = g_Qu(Vxx, Vx, costQ, costR, x, u);
Quu = g_Quu(Vxx, Vx, costQ, costR, x, u);
Qux = g_Qux(Vxx, Vx, costQ, costR, x, u);
Qxx = g_Qxx(Vxx, Vx, costQ, costR, x, u);

Vx_next = Qx - Qu * pinv(Quu) * Qux;
Vxx_next = Qxx - Qux' * pinv(Quu) * Qux;

change_log(i, :) = [norm(Vxx_next - Vxx), norm(Vx_next - Vx)];

    K_log(:, :, i) = K;

Vx = Vx_next;
Vxx = Vxx_next;
end

figure()
subplot(1, 2, 1); semilogy(change_log)

K = pinv(Quu) * Qux
eig(g_A(x, u) - g_B(x, u)*K)

x_log = zeros(Count, n);
x = 0.01*randn(n, 1);
for i = 1:Count
    x_log(i, :) = x;
    
    K = K_log(:, :, Count - i + 1);
    k = K_log(:, :, Count - i + 1);
    
    
    x = g_f(x, -K*x);
end
subplot(1, 2, 2)
plot(x_log)